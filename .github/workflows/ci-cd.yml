name: CI / CD – Build, Push & Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  # ── 1. Lint & Type-check ─────────────────────────────────────────────────────
  lint:
    name: Lint & Typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: Install backend deps
        run: npm ci
        working-directory: backend

      - name: Install frontend deps
        run: npm ci
        working-directory: frontend

      - name: Generate Prisma client
        run: npx prisma generate
        working-directory: backend

      - name: Typecheck backend
        run: npm run typecheck
        working-directory: backend

      - name: Typecheck frontend
        run: npm run typecheck
        working-directory: frontend

  # ── 2. Run backend tests ──────────────────────────────────────────────────────
  test:
    name: Backend Tests
    runs-on: ubuntu-latest
    needs: lint
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: league
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: league_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install deps
        run: npm ci
        working-directory: backend

      - name: Run migrations
        run: npx prisma migrate deploy
        working-directory: backend
        env:
          DATABASE_URL: postgresql://league:testpass@localhost:5432/league_test

      - name: Run tests
        run: npm test
        working-directory: backend
        env:
          DATABASE_URL: postgresql://league:testpass@localhost:5432/league_test
          JWT_SECRET: test-secret-that-is-long-enough-32c
          NODE_ENV: test

  # ── 3. Build & Push Docker Images ─────────────────────────────────────────────
  build:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs: test
    # Only push on main branch (not PRs)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata – backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend
          tags: |
            type=sha,prefix=,format=short
            type=raw,value=latest

      - name: Build & push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Extract metadata – frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend
          tags: |
            type=sha,prefix=,format=short
            type=raw,value=latest

      - name: Build & push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          build-args: |
            VITE_API_URL=/api
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Store the short SHA for the deploy job
      - name: Output image tag
        id: image-tag
        run: echo "tag=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    outputs:
      image_tag: ${{ steps.image-tag.outputs.tag }}

  # ── 4. Deploy to TrueNAS ──────────────────────────────────────────────────────
  deploy:
    name: Deploy to TrueNAS
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          tags: tag:ci

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.TRUENAS_HOST }}
          username: ${{ secrets.TRUENAS_USER }}
          key: ${{ secrets.TRUENAS_SSH_KEY }}
          port: ${{ secrets.TRUENAS_PORT || 22 }}
          script: |
            set -e

            APP_DIR="${{ secrets.APP_DIR || '/mnt/tank/putting-league' }}"
            IMAGE_TAG="${{ needs.build.outputs.image_tag }}"

            echo "→ Pulling latest images (tag: $IMAGE_TAG)"
            cd "$APP_DIR"

            # Pull new images
            docker pull ghcr.io/${{ github.repository }}/backend:${IMAGE_TAG}
            docker pull ghcr.io/${{ github.repository }}/frontend:${IMAGE_TAG}

            # Write production .env from GitHub secrets
            cat > .env << EOF
            POSTGRES_USER=league
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_DB=league_db
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_EXPIRY=7d
            MAGIC_LINK_EXPIRY_MINUTES=15
            SMTP_HOST=smtp.resend.com
            SMTP_PORT=587
            SMTP_USER=resend
            SMTP_PASS=${{ secrets.SMTP_PASS }}
            SMTP_FROM=onboarding@mvpl.golf
            APP_URL=${{ secrets.APP_URL }}
            HTTP_PORT=5173
            GITHUB_REPOSITORY=${{ github.repository }}
            IMAGE_TAG=${IMAGE_TAG}
            EOF

            # Sync postgres password (handles POSTGRES_PASSWORD rotation).
            # POSTGRES_USER=league means no 'postgres' PG role exists, so we
            # temporarily enable trust auth on the local unix socket to run ALTER USER.
            docker compose exec -T postgres sh -c "
              echo 'local all all trust' | cat - /var/lib/postgresql/data/pg_hba.conf > /tmp/ph
              mv /tmp/ph /var/lib/postgresql/data/pg_hba.conf
              kill -HUP \$(head -1 /var/lib/postgresql/data/postmaster.pid)
            " \
            && sleep 1 \
            && docker compose exec -T postgres psql -U league \
                 -c "ALTER USER league PASSWORD '${{ secrets.POSTGRES_PASSWORD }}';" \
            && docker compose exec -T postgres sh -c "
              tail -n +2 /var/lib/postgresql/data/pg_hba.conf > /tmp/ph
              mv /tmp/ph /var/lib/postgresql/data/pg_hba.conf
              kill -HUP \$(head -1 /var/lib/postgresql/data/postmaster.pid)
            " \
            && echo "→ Postgres password synced" \
            || echo "⚠️  Postgres password sync skipped (postgres not running?)"

            # Rolling restart: backend first (runs migrations), then frontend + nginx
            docker compose up -d --no-deps --pull never backend
            sleep 10
            docker compose up -d --no-deps --pull missing frontend nginx

            # Remove old/dangling images to save disk space
            docker image prune -f

            echo "✅ Deploy complete"
